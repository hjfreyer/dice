<!DOCTYPE html>
<html>
  <head>
    <script src="bower_components/purl/purl.js"></script>
    <script src="bower_components/platform/platform.js"></script>
    <script src="app.js"></script>

    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/google-signin/google-signin.html">
    <!-- <link rel="import" href="bower_components/google-apis/google-client-api.html"> -->

    <polymer-element name="x-global" attributes="value">
      <script>
        var value = {};

        Polymer({
          created: function() {
            this.value = value;
          },
          valueChanged: function() { this.value = value; }
        });
      </script>
    </polymer-element>

    <!-- <polymer-element name="google-rpc" attributes="params"> -->
    <!--   <template> -->
    <!--     <x-global value="{{global}}"></x-global> -->
    <!--     <core-ajax id="rpc"></core-ajax> -->
    <!--   </template> -->
    <!--   <script> -->
    <!--     Polymer({ -->

    <!--     }); -->
    <!--   </script> -->
    <!-- </polymer-element> -->

    <!-- <polymer-element name="x-app" params="appIsReady"> -->
    <!--   <template> -->
    <!--     <x-global id="global"></x-global> -->
    <!--     <template if="{{appIsReady}}"> -->
    <!--       <google-signin -->
    <!--clientId="895593330219-dagqsd3t6aqm8qtvp9t02mkd4aafnkbi.apps.googleusercontent.com" -->
    <!--          scopes="https://www.googleapis.com/auth/drive.file -->
    <!--                  https://www.googleapis.com/auth/drive.install" -->
    <!--          on-google-signin-success="{{signin}}"> -->
    <!--       </google-signin> -->

    <!--       <google-api-loader id="driveLoader" name="drive" -->
    <!--                          version="v2" -->
    <!--                          on-google-api-load="{{foo}}"></google-api-loader> -->

    <!--       <google-api-loader id="pickerLoader" name="picker" -->
    <!--                          version="v1" -->
    <!--                          on-google-api-load="{{foo2}}"></google-api-loader> -->

    <!--       Yo -->


    <!--     </template> -->
    <!--   </template> -->

    <!--   <script> -->
    <!--     Polymer({ -->
    <!--     appIsReady: false, -->
    <!--     signin: function(e) { -->
    <!--     this.auth_token = e.detail.result.access_token; -->
    <!--     }, -->
    <!--     foo: function() { console.log(this.$.driveLoader.api); -->


    <!--     console.log(gapi); -->
    <!--     }, -->
    <!--     foo2: function() { console.log(this.$.pickerLoader.api); } -->
    <!--     }); -->
    <!--   </script> -->
    <!-- </polymer-element> -->
    <polymer-element name="x-app">
      <template>
        <x-global value="{{global}}"></x-global>
        <google-signin
           clientId="895593330219-dagqsd3t6aqm8qtvp9t02mkd4aafnkbi.apps.googleusercontent.com"
           scopes="https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.install"
           on-google-signin-success="{{signIn}}">
        </google-signin>
        <button on-click="{{pick}}">Pick</button>
        <input value="{{m.title}}">
      </template>
      <script>

var MyModel = function(){};

        Polymer({
          ready: function() {
            this.global.url = purl();
            this.driveState = JSON.parse(this.global.url.param('state'));
            console.log(this.driveState);
         },
          signIn: function(e) {
            this.global.authToken = e.detail.result;
            gapi.auth.setToken(this.global.authToken);
console.log(gapi.auth.getToken());
        gapi.drive.realtime.custom.registerType(MyModel, 'MyModel');
MyModel.prototype.title = gapi.drive.realtime.custom.collaborativeField('title');

            gapi.drive.realtime.load(this.driveState.ids[0], this.onFileLoaded.bind(this));
          },
          pick: function() {
            createPicker(this.global.authToken);
          },
          onFileLoaded: function(doc) {
        this.model = doc.getModel();
//        this.model.getRoot().set('foo', 'bar');
        window.rroot = this.model.getRoot();

        this.m = window.rroot.get('m');


if (!this.m) {
        this.m = this.model.create('MyModel');
this.m.title='yo';
        window.rroot.set('m', this.m);
}

        },
        });
      </script>
    </polymer-element>


  </head>
  <body>
    <x-app id="app"></x-app>

    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>
    <!-- <script type="text/javascript" src="https://apis.google.com/js/client.js"></script> -->

    <script>
      gapi.load('picker,drive-realtime');
    </script>
  </body>
</html>
